<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chessfield Demo</title>

    <link rel="stylesheet" type="text/css" href="assets/chessfield.base.css" />
    <style>
      body {
        display: flex;
        flex-wrap: wrap;
      }

      body > div {
        margin: 10px;
      }

      .chessfield {
        width: 500px;
        height: 500px;
        border: 1px solid white;
      }

      cf-board {
        background-color: #bfcfdd;
      }
    </style>

    <script type="module">
      import { Chessfield } from './src/chessfield.ts';

      const board1 = new Chessfield(document.getElementById('board-1'), {
        orientation: 'white',
        view: 'top',
      });
      board1.setFen('rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1', 'e2e4');

      new Chessfield(document.getElementById('board-2'), {
        fen: 'r2q2k1/1p6/p2p4/2pN1rp1/N1Pb2Q1/8/PP1B4/R6K b - - 2 25',
        view: 'white',
      });

      const chessfieldTv = new Chessfield(document.getElementById('board-3'), {
        orientation: 'black',
        view: 'right',
      });

      const randomFens = [
              // Not so random: https://www.chess.com/article/view/best-chess-moves#shirov
              '8/4B3/6p1/8/p2p3P/1k5P/5K2/8 w - - 6 54', // Shirov's Jaw-Dropping Bishop Sacrifice
              '2rq2kb/pbQr3p/2n1R1pB/1pp2pN1/3p4/P1PP2P1/1P3PBP/4R1K1 b - - 1 1', // Meier's Spectacular Sacrifice
      ]

      const toggle = document.querySelector('.js-tv-toggle');
      toggle.addEventListener('click', () => {
        if (toggle.innerText === 'start') {
          toggle.innerText = 'stop';
          startTv();
        } else {
          toggle.innerText = 'start';
          stopTv();
        }
      });

      let reader = null; // Store the reader globally to control it
      let isStreaming = false; // Flag to track streaming status

      const startTv = () => {
        if (isStreaming) return;
        isStreaming = true;

        fetch('https://lichess.org/api/tv/feed')
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Network response was not ok');
                  }
                  reader = response.body.getReader();
                  const decoder = new TextDecoder('utf-8');
                  let buffer = '';

                  const processStream = ({ done, value }) => {
                    if (!isStreaming) {
                      reader.cancel(); // Stop the stream if streaming is stopped
                      return;
                    }
                    if (done) {
                      console.log('Stream completed');
                      return;
                    }

                    // Decode and process the stream
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    lines.forEach(line => {
                      if (line.trim()) {
                        try {
                          const json = JSON.parse(line);
                          const fen = json.d.fen;
                          const lastMove = json.d.lm;
                          chessfieldTv.setFen(fen, lastMove);
                        } catch (e) {
                          console.error(`JSON Parse Error: ${e}`);
                        }
                      }
                    });

                    // Continue reading
                    reader.read().then(processStream);
                  };

                  reader.read().then(processStream);
                })
                .catch(error => console.error('Streaming error:', error));
      };

      const stopTv = () => {
        if (!isStreaming) return;
        isStreaming = false;
        if (reader) {
          reader.cancel(); // Terminate the reader to stop fetching
          console.log('Streaming stopped');
        }
      };
    </script>
  </head>
  <body>
<!--    <div>-->
<!--      basic board, default config-->
<!--      <div class="chessfield" id="board-1"></div>-->
<!--    </div>-->
<!--    <div>-->
<!--      board with a fen-->
<!--      <div class="chessfield" id="board-2"></div>-->
<!--    </div>-->
    <div>
      board with a fen updated (<button class="js-tv-toggle">start</button>)
      <div class="chessfield" id="board-3"></div>
    </div>

    <script type="module" src="/src/chessfield.ts"></script>
  </body>
</html>
